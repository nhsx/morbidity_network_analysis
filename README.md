# MultiNet - Multi-Morbidity Network Analysis

## Build and visualise multi-morbidity networks to discover significant disease associations.

This command line tool provides user-friendly and automated multi-morbidity network analysis.
Detect significant associations are correcting for confounding factors such as Age and Sex.
Includes community detection for und-irected networks.
Option to build directed networks when diagnosis times are available.

***Note: Directed network analysis is still experimental.***

## Table of contents

  * [Installation](#installation)
  * [Configuration](#configuration)
  * [Usage](#usage)
  * [Example output](#example-output)

## Installation

```bash
pip install git+https://github.com/nhsx/morbidity_network_analysis.git
```

## Configuration
MultiNet is configured via a single configuration file in YAML format.
The configuration describes the file-path of the input data and column names of the desired strata and diseases.
All columns provided in the configuration must be present in the input data.
MultiNet can automatically handle gzipped compressed files and file seperator can be configured to any relevant character.
The configuration file shown below is suitable for the example data generated by ```CMA simulate``` (see below).

```bash
file: CMA-example.csv # Path to input data.
strata: # Column names of strata to correct for confounders.
    - sex
    - age
seperator: ','
chunksize: 10000 # Read file in chunks to reduce memory.
codes:
    Primary_Diagnosis_Code: Primary_Diagnosis_Time
    Secondary_Diagnosis_Code_01: Secondary_Diagnosis_Time_01
    Secondary_Diagnosis_Code_02: Secondary_Diagnosis_Time_02
    Secondary_Diagnosis_Code_03: Secondary_Diagnosis_Time_03
    Secondary_Diagnosis_Code_04: Secondary_Diagnosis_Time_04
    Secondary_Diagnosis_Code_05: Secondary_Diagnosis_Time_05
    Secondary_Diagnosis_Code_06: Secondary_Diagnosis_Time_06
    Secondary_Diagnosis_Code_07: Secondary_Diagnosis_Time_07
    Secondary_Diagnosis_Code_08: Secondary_Diagnosis_Time_08
    Secondary_Diagnosis_Code_09: Secondary_Diagnosis_Time_09
    Secondary_Diagnosis_Code_10: Secondary_Diagnosis_Time_10
    Secondary_Diagnosis_Code_11: Secondary_Diagnosis_Time_11
    Secondary_Diagnosis_Code_12: Secondary_Diagnosis_Time_12
    Secondary_Diagnosis_Code_13: Secondary_Diagnosis_Time_13
    Secondary_Diagnosis_Code_14: Secondary_Diagnosis_Time_14
    Secondary_Diagnosis_Code_15: Secondary_Diagnosis_Time_15
    Secondary_Diagnosis_Code_16: Secondary_Diagnosis_Time_16
    Secondary_Diagnosis_Code_17: Secondary_Diagnosis_Time_17
    Secondary_Diagnosis_Code_18: Secondary_Diagnosis_Time_18
    Secondary_Diagnosis_Code_19: Secondary_Diagnosis_Time_19
    Secondary_Diagnosis_Code_20: Secondary_Diagnosis_Time_20
    Secondary_Diagnosis_Code_21: Secondary_Diagnosis_Time_21
    Secondary_Diagnosis_Code_22: Secondary_Diagnosis_Time_22
    Secondary_Diagnosis_Code_23: Secondary_Diagnosis_Time_23
    Secondary_Diagnosis_Code_24: Secondary_Diagnosis_Time_24
    Secondary_Diagnosis_Code_25: Secondary_Diagnosis_Time_25
```


## Usage
MultiNet can be run from the command line and additional help is provided via ```CMA --help```.

### Generate Example Data
The ```simulate``` sub-command generates suitably formatted input data for testing functionality.

```bash
CMA simulate > CMA-example.csv
```

### Stage 1 - Processing input and generate edge weights.
The ```process``` sub-command reads the input data and performs a stratified odds-ratio test (Mantel-Haenszel method) for each pair of morbidities.
The output of this analysis is written to a pickle file in preparation for network construction and visualisation.

```bash
CMA process config.yaml processed.pkl
```

### Stage 2 - Network Construction and Visualisation
The ```network``` sub-command parses the output of ```CMA process``` into a network and generate an interactive visualisation.
Currently the output is written to a file called ```exampleNet.html```.

```bash
CMA network config.yaml processed.pkl
```

### Alternative Method - Run Full Workflow
MultiNet can be optionally run in a single command that combines stage 1 and stage 2.
However, it is generally advised to run each stage separately.
Optimal network visualisation parameters can be quickly explored without having to repeatedly re-run stage 1, which may require considerable compute time.

```bash
CMA analyse config.yaml
```

## Example output
The example network is designed to test MultiNet functionality and configuration.
The simulated data defines relationship among the nodes according to their numerical values.
These relationships are arbitrary but are defined within the simulated data.
MorbiNet can successfully recover these relationships in the network analysis.

Odd numbered nodes with the same second digit are more likely to associate with one another (e.g. 11, 13, 15, 17, 19).
In addition, nodes ending in 9 or 1 have significant associated with the adjacent cluster (e.g. 19 and 20 are coassiciated).
Finally node relationships are directional.
For example, 12 is associated with 14 but 14 is **not** associated with 12.

![Example Network Output](./README_files/exampleNet.png)
